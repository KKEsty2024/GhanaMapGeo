<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geofence Map</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 100vh; }
        #filter-container {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgb(158, 34, 34);
            padding: 10px;
            border-radius: 4px;
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #filter-container h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        #filter-container select {
            padding: 5px;
            font-size: 14px;
        }
        #site-count {
            margin-top: 10px;
            font-size: 14px;
            font-weight: bold;
        }
        .mapboxgl-popup-content {
            font-size: 14px;
        }
        .tooltip {
            background-color: white;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="filter-container">
        <h3>Filter by Geofence Category</h3>
        <label for="geofenceCategory">Choose a category:</label>
        <select id="geofenceCategory">
            <option value="all">All Categories</option>
        </select>
        <div id="site-count">Sites Count: 0</div>
    </div>
    <div id="map"></div>

    <script>
        // Access Token for Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuaWVsLWZpbmRydHJhY2tpbmciLCJhIjoiY20yNG52NnA3MGVmbjJqcXV1Z2FtczhubiJ9.y26OUUxKLe2ZP4YUAw1a8Q';

        // Initialize Mapbox map
        const map = new mapboxgl.Map({
            container: 'map', 
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-1.0232, 7.9465], // Set center to Ghana's coordinates
            zoom: 6
        });
        map.addControl(new mapboxgl.NavigationControl());
        // Function to load GeoJSON and display sites
        async function loadGeoData() {
            const response = await fetch('geo__sites.json'); // Load the transformed JSON file
            const data = await response.json();
            return data;
        }

        // Add markers to the map
        function addMarkers(map, sites) {
            sites.forEach(site => {
                // Check if coordinates are valid before adding marker
                if (!isNaN(site.lon) && !isNaN(site.lat)) {
                    const markerElement = createCustomMarker(site.icon);
                    const marker = new mapboxgl.Marker({
                        element: markerElement
                    })
                    .setLngLat([site.lon, site.lat])
                    .setPopup(new mapboxgl.Popup().setHTML(`<strong>${site.name}</strong><br>Site ID: ${site.id}<br>Geofence: ${site.geofenceDistance}m`))
                    .addTo(map);

                    // Add hover effect
                    markerElement.addEventListener('mouseenter', () => {
                        map.getCanvas().style.cursor = 'pointer'; // Change cursor on hover
                        marker.togglePopup(); // Show popup on hover
                    });
                    markerElement.addEventListener('mouseleave', () => {
                        map.getCanvas().style.cursor = ''; // Reset cursor
                        marker.togglePopup(); // Hide popup on hover out
                    });
                } else {
                    console.warn(`Invalid coordinates for site: ${site.name}, ID: ${site.id}`);
                }
            });
        }

        // Function to create a custom marker
        function createCustomMarker(iconUrl) {
            const markerDiv = document.createElement('div');
            markerDiv.style.backgroundImage = `url(${iconUrl})`;
            markerDiv.style.width = '30px';
            markerDiv.style.height = '30px';
            markerDiv.style.backgroundSize = 'cover';
            return markerDiv;
        }

        // Add geofence categories to the dropdown filter
        function populateFilter(categories) {
            const dropdown = document.getElementById('geofenceCategory');
            const uniqueCategories = Array.from(new Set(categories));

            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.text = category;
                dropdown.add(option);
            });
        }

        // Filter markers based on selected geofence category
        function filterMarkers(sites, selectedCategory) {
            const filteredSites = selectedCategory === 'all' 
                ? sites 
                : sites.filter(site => site.geofenceCategory === selectedCategory);

            // Remove existing markers
            document.querySelectorAll('.mapboxgl-marker').forEach(marker => marker.remove());

            // Add filtered markers
            addMarkers(map, filteredSites);

            // Update site count
            document.getElementById('site-count').textContent = `Sites Count: ${filteredSites.length}`;
        }

        // Load sites and set up filter
        loadGeoData().then(sites => {
            // Add all sites as markers initially
            addMarkers(map, sites);

            // Get unique geofence categories and populate the filter dropdown
            const categories = sites.map(site => site.geofenceCategory);
            populateFilter(categories);

            // Update site count for initial load
            document.getElementById('site-count').textContent = `Sites Count: ${sites.length}`;

            // Add event listener to filter dropdown
            const geofenceFilter = document.getElementById('geofenceCategory');
            geofenceFilter.addEventListener('change', (event) => {
                const selectedCategory = event.target.value;
                filterMarkers(sites, selectedCategory);
            });
        });
    </script>
</body>
</html>
